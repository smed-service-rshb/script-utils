## Набор скриптов и настроек для сборки приложения для различных стендов (локальных и в ООО "СоюзМедСервис")
В ветке **master** находятся настройки и скрипты для сборки приложения для следующих стендов:
* тестовый стенд в (TEST) ООО "СоюзМедСервис", собранный на основе текущего состояния веток **develop**, **master** или любой произвольной ветки

Для успешной сборки проекта необходимо, чтобы предварительно в окружении, на котором будут запускаться скрипты были доступны из
командной строки следующие утилиты: **javac**, **mvn** и **npm**. Для **npm** должен быть установлен пакет **lerna** через команду **npm install --global lerna**

###Сборка дистрибутива
Для сборки дистрибутивов следует запускать следующие файлы.

####Сборка из предопределённых веток (develop или master):
* **build-sms-develop-test-stand-distrib.bat** - сборка дистрибутива для тестового стенда (TEST) в ООО "СоюзМедСервис" на основе текущего состояния веток **develop**

####Сборка из произвольной ветки
Для сборки дистрибутива из произвольной ветки следует использовать следующие файлы, передавая в качестве первого параметра имя ветки:
* **build-sms-release-test-stand-distrib.bat** - сборка дистрибутива для тестового стенда (TEST) в ООО "СоюзМедСервис" на основе произвольной ветки.

Ниже приведён пример запуска сборки дистрибутива для тестового стенда (TEST) из ветки release/3.0.0
```
build-sms-release-test-stand-distrib.bat release/3.0.0
```
Если во время сборки обнаружится, что для какого-то компонента системы нет указанной ветки, то сборка будет производиться из ветки по умолчанию (develop).
Для контроля следует использовать файл **release-notes.txt**, который находится в корне каталога с собранным дистрибутивом.
В этом файле указывается список веток и номеров ревизий, из которых выполнялась сборка компонентов дистрибутива.  

###Настройки для различных стендов
Настройки для различных стендов находятся в отдельных каталогах:
* **_settings/_sms-test-stand** - для тестового стенда (TEST) в ООО "СоюзМедСервис"

### Структура каталога с дистрибутивом
Каталог с дистрибутивом имеет следующую структуру:
```
_distrib_*
    db-scripts
      _flyway - каталог с дистрибутивом flyway, который используется для миграции БД
      auth_service - скрипты для создания БД микросервиса авторизации
        *.sql - SQL-скрипты для миграции 
        flyway.conf - настройки flyway для миграции БД микросервиса авторизации
        baseline-db.bat - скрипт для создания таблиц flyway при запуске под Windows; выполняется при установке БД 
        baseline-db - скрипт для создания таблиц flyway при запуске под Linux; выполняется при установке БД 
        migrate-db.bat - скрипт для запуска миграции БД микросервиса авторизации при запуске под Windows 
        migrate-db - скрипт для запуска миграции БД микросервиса авторизации при запуске под Linux
      common_dict - скрипты для создания БД микросервиса общих справочников
        *.sql - SQL-скрипты для миграции 
        flyway.conf - настройки flyway для миграции БД микросервиса общих справочников
        baseline-db.bat - скрипт для создания таблиц flyway при запуске под Windows; выполняется при установке БД 
        baseline-db - скрипт для создания таблиц flyway при запуске под Linux; выполняется при установке БД 
        migrate-db.bat - скрипт для запуска миграции БД микросервиса общих справочников при запуске под Windows 
        migrate-db - скрипт для запуска миграции БД микросервиса общих справочников при запуске под Linux  
      insurance_service - скрипты для создания БД микросервиса "Страхование"
        *.sql - SQL-скрипты для миграции 
        flyway.conf - настройки flyway для миграции БД микросервиса "Страхование"
        baseline-db.bat - скрипт для создания таблиц flyway при запуске под Windows; выполняется при установке БД 
        baseline-db - скрипт для создания таблиц flyway при запуске под Linux; выполняется при установке БД
        migrate-db.bat - скрипт для запуска миграции БД микросервиса "Страхование" при запуске под Windows 
        migrate-db - скрипт для запуска миграции БД микросервиса "Страхование" при запуске под Linux
    nginx
      nginx-static - каталог со статическими ресурсами приложения "АРМ Работника" (js, html, картинки)
      default.conf - файл с настройками nginx
    api-gateway.war - архив с приложением API-Gatway
    auth-service.war - архив с приложением "Сервис авторизации"
    common-dict.war - архив с приложением "Сервис общих справочников"
    insurance-service.war - архив с приложением "Страхование"
    release-notes.txt - файл с указанием веток и номеров ревизий, из которых выполнялась сборка компонентов дистрибутива
```

### Развертывание БД, инициализация flyway
При развертывании пустой БД необходимо выполнить создание схемы БД через скрипт 01-create-schema.sql.
Затем необходимо выполнить вызов **baseline-db.bat** или **baseline-db**. В БД микросервиса будет создана таблица
**flyway_schema_history**, в которой будет хранится информация о текущей версии БД. Параметры подключения к БД и 
описаны в файле **flyway.conf**, находящемся в том же каталоге, где расположены **baseline-db.bat** или **baseline-db**.
Затем необходимо выполнить миграцию БД путём вызова **migrate-db.bat** или **migrate-db**.

### Выполнение миграции БД с использованием flyway
Для того чтобы выполнить обновление БД конкретного микросеривиса, необходимо перейти в каталог с SQL скриптами
и выполнить вызов **migrate-db.bat** или **migrate-db**. Параметры подключения к БД и параметры миграции описаны в файле **flyway.conf**,
находящемся в том же каталоге, где расположены **migrate-db.bat** и **migrate-db**.

Если flyway отказывается от выполнения миграции по причине нарушения чексуммы скриптов, то сообщите об этой ошибке разработчикам.
Вероятной причиной такого является внесение изменений в ранее прогнанные в БД скрипты. Это является ошибкой и разработчики должны будут
откатить изменения в этом файле и добавить новый файл со скриптами.